<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <link rel="stylesheet" href="infocenter.css" type="text/css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kjetil's Information Center - VT100 Terminal Emulator on Raspberry Pi Pico</title>
  </head>
  <body>
    <div class="header">
      <img src="infocenter_header.png" alt="Kjetil's Information Center: A Blog About My Projects"/>
    </div>
    <div class="menu">
      <b>Index:</b>
      <p>
        <a href="index-topic.html">Index By Topic</a><br />
        <a href="index.html">Index By Date</a><br />
        <a href="rss.xml">RSS Feed</a><br />
      </p>
      <hr />
      <b>Contact:</b>
      <p>
        <a href="https://github.com/kobolt">https://github.com/kobolt</a><br />
        <a href="https://gitlab.com/users/kobolt/projects">https://gitlab.com/kobolt</a><br />
        kobolt.anarion (at) gmail.com<br />
      </p>
      <hr />
      <b>Quality assurance:</b>
      <p>
        <a href="http://validator.w3.org/check?uri=referer">
          <img class="noborder"
            src="valid-xhtml10.png"
            alt="Valid XHTML 1.0 Strict" />
        </a>
        <br />
        <a href="http://jigsaw.w3.org/css-validator/">
          <img class="noborder" 
            src="valid-css.gif"
            alt="Valid CSS" />
        </a>
        <br />
        <a href="https://validator.w3.org/feed/">
          <img class="noborder"
            src="valid-rss-rogers.png"
            alt="Valid RSS" />
        </a>
        <br />
      </p>
    </div>
    <div class="content">
      <h1>VT100 Terminal Emulator on Raspberry Pi Pico</h1>
      <p>
        Here is another Raspberry Pi Pico project, this time a DEC <a href="https://en.wikipedia.org/wiki/VT100">VT100 Terminal</a> emulator. Host communication goes through the &#34;standard&#34; UART, <a href="https://en.wikipedia.org/wiki/Composite_video">composite video</a> is used for the output and a <a href="https://en.wikipedia.org/wiki/PS/2_port">PS/2</a> keyboard is used for the input. I have named this program &#34;Terminominal&#34;.<br />
        <br />
        Since I&#39;m Norwegian I have made some design choices that reflect this. The first is that the composite video uses the <a href="https://en.wikipedia.org/wiki/PAL">PAL</a> standard at 50 Hz. The keyboard scancode handling expects the Norwegian layout, but this can be changed to US layout with a compile time define. Finally the built-in font/character set is <a href="https://en.wikipedia.org/wiki/ISO/IEC_8859-1">ISO-8859-1</a> (latin-1) compatible.<br />
        <br />
        The composite video (CVBS) is generated by one of the Pico&#39;s PIO cores running at 40 MHz, which in turn creates time slices of 0.05 microseconds that affects a lot of the architecture in this program. After taking care of overscan, there is 880 dots on 240 scanlines remaining for the &#34;visible&#34; picture. First I tried using a standard CGA font at 8x8 which would give 110 columns by 30 rows, but the picture was almost unreadable. Instead I designed my own 11x10 font which fits perfectly for a 80 column by 24 rows picture and is quite readable on a <a href="https://en.wikipedia.org/wiki/Cathode-ray_tube">CRT</a> display.<br />
        <br />
        The first ARM core reads the UART for incoming bytes and processes these to emulate the VT100 behaviour. Escape codes are processed and then a &#34;screen&#34; array is updated which represents all the characters currently on the screen. The second ARM core fetches characters from this &#34;screen&#34; array, if they have changed, and converts these to scanline and dot information using the font data and puts this into a &#34;frame&#34; array. <a href="https://en.wikipedia.org/wiki/Direct_memory_access">DMA</a> is used by the PIO core to fetch the &#34;frame&#34; array and push this out on the GPIO pins.<br />
        <br />
        A 2-bit DAC for the video is created by using two resistors. Since the GPIO voltage is 3.3V and the composite video input impedance (on a TV set) is 75 ohms, good values are 680 ohms and 220 ohms for these resistors. It is also possible to use 1000 ohms and 330 ohms, which gives a slightly dimmer picture. The 2 bits gives four signal levels, where one is sync and the other three shades of: black, grey and white.<br />
        <br />
        The PS/2 keyboard protocol is handled by the second PIO core which generates an interrupt once the required 11 bit frame has been read. The interrupt handler converts the scancode to the appropriate byte and sends it out on the UART. Note that since the PS/2 protocol uses 5V and the Raspberry Pi Pico GPIO pins uses 3.3V a <a href="https://en.wikipedia.org/wiki/Level_shifter">level shifter</a> is needed in between!<br />
        <br />
        The VT100 emulation has been tested with <a href="https://invisible-island.net/vttest/">vttest</a> and the most important features are supported. VT52 and VT102 modes are not really supported. It should work fine against a Linux host at least. The UART runs at 115200 baud, but can be changed through re-compilation to other speeds.<br />
        <br />
        Here is a block diagram which shows the architecture:<br />
      </p>
      <img class="border" src="images/terminominal-diagram.png" alt="Terminominal Diagram" />
      <p>
        <br />
        Here is a connection/function table for the GPIO pins:<br />
      </p>
        <div class="box">
          <pre>
|--------|-----------|------------|-------------------------|
| Pin No | Pin Name  | Function   | Connected To            |
|--------|-----------|------------|-------------------------|
| 1      | GP0       | UART TX    |                         |
| 2      | GP1       | UART RX    |                         |
| 6      | GP4       | PS/2 Data  | 3.3V&lt;-&gt;5V Level Shifter |
| 7      | GP5       | PS/2 Clock | 3.3V&lt;-&gt;5V Level Shifter |
| 21     | GP16      | CVBS DAC   | 680 Ohm Resistor        |
| 22     | GP17      | CVBS DAC   | 220 Ohm Resistor        |
| 36     | 3V3 (OUT) | +3.3V      | 3.3V&lt;-&gt;5V Level Shifter |
| 40     | VBUS      | +5V        | 3.3V&lt;-&gt;5V Level Shifter |
|--------|-----------|------------|-------------------------|
          </pre>
        </div>
      <p>
        <br />
        Here is a breadboard layout created with <a href="https://fritzing.org/">Fritzing</a>:<br />
      </p>
      <img class="border" src="images/terminominal-breadboard.png" alt="Terminominal Breadboard" />
      <p>
        <br />
        Notice that the GPIO pins for the composite video is on the other end of the Pico. This was needed because it generates a lot of noise, so much in fact that it affects the PS/2 signalling. This would result in lost bits and parity errors.<br />
        <br />
        A snapshot of version 0.1 can be downloaded <a href="supplies/terminominal-0.1.tar.gz">here</a>, or check the Git repository <a href="https://github.com/kobolt/terminominal">here</a>. Check the included README.md for build instructions. It is also possible to compile an <a href="http://libsdl.org/">SDL</a> version which is used for testing directly on Linux.<br />
        <br />
        I appreciate the good instructions from <a href="https://vanhunteradams.com/Pico/VGA/VGA.html">Van Hunter Adams</a> on how to use DMA on the Raspberry Pi Pico and <a href="http://javiervalcarce.eu/html/arduino-tv-signal-generator-en.html">Javier Valcarce</a> on how to generate PAL video signals.<br />
        <br />
        Here is a photo of Terminominal running on one Pico and connected to another Pico running the <a href="article-196.html">kaytil CP/M emulator</a>:<br />
      </p>
      <img class="border" src="images/terminominal-kaytil.jpg" alt="Terminominal and Kaytil" />
      <p>
        <br />
      </p>
      <i>
        Topic:
        <a href="index-topic.html#open_source">Open Source</a>,
        by
        Kjetil
        @ 
        03/06-2022, 
        <a href="article-198.html">Article Link</a>
      </i>
      <br />
    </div>
  </body>
</html>
